# ML Prediction Service

## Обзор сервиса

Сервис для прогнозирования вероятности транзакционного фрода с помощью CatBoost модели.

### Ключевые возможности:
- **Прогнозирование**: POST-запросы для получения предсказаний модели
- **История запросов**: Автоматическое сохранение всех запросов в базу данных
- **Статистика**: Агрегирование данных по выполненным запросам
- **Асинхронность**: Все операции с БД выполняются асинхронно

### Технологический стек:
- FastAPI (веб-фреймворк)
- SQLAlchemy 2.0 (асинхронный ORM)
- SQLite (база данных)
- CatBoost (ML модель)
- Pydantic (валидация данных)

## Архитектура
```bash
├── api                         # Fast API
│   ├── main.py                 # Точка входа в приложение FastAPI
│   ├── database.py             # Настройки и подключение к базе данных
│   ├── dependencies.py         # Зависимости для загрузки моделей и переменных
│   ├── middleware.py           # Middleware для логирования запросов
│   ├── models.py               # SQLAlchemy модели базы данных
│   ├── schemas.py              # Pydantic схемы для валидации данных
│   └── routers/                # Маршрутизаторы API
│       ├── forward.py          # Роутер для получения предсказаний
│       └── history.py          # Роутер для работы с историей запросов
...
```

## Эндпоинты API

### Основные эндпоинты:

1. **GET /** - Корневой эндпоинт с документацией
2. **GET /health** - Проверка работоспособности
3. **POST /api/forward** - Получение предсказания модели
4. **GET /api/history** - Полная история запросов
5. **GET /api/history/stats** - Статистика по истории

## Тестирование через Swagger UI

### Шаги для запуска

1. **Установка зависимостей**
```bash
# Установка зависимостей
poetry install

# Активировать окружение
source $(poetry env info --path)/bin/activate
```

2. **Запуск сервиса**
```bash
uvicorn api.main:app --reload --host 0.0.0.0 --port 8000
```

| Компонента | Что делает | Для чего нужно |
|-----------|------------|----------------|
| `uvicorn` | ASGI-сервер | Запускает FastAPI приложение |
| `api.main:app` | Путь к приложению | - `api.main` = файл `main.py` в папке `api`<br>- `:app` = переменная `app` в этом файле |
| `--reload` | Автоперезагрузка | Сервер автоматически перезапускается при изменении кода |
| `--host 0.0.0.0` | Привязка к адресу | Делает сервер доступным по:<br>- `localhost`<br>- `127.0.0.1`<br>- Вашему IP-адресу в локальной сети |
| `--port 8000` | Порт сервера | Стандартный порт для разработки<br>Доступ: `http://localhost:8000` |


### Открытие документации API
Перейдите в браузере по адресу:

```
http://localhost:8000/docs
```

### Проверка эндпоинтов

#### 1. GET / — Информация о сервисе
1. Нажмите кнопку **Try it out**
2. Нажмите **Execute**

**Ожидаемый результат:**  
JSON с описанием всех эндпоинтов

#### 2. GET /health — Проверка здоровья
1. Нажмите **Try it out**
2. Нажмите **Execute**

**Ожидаемый результат:**
```json
{"status": "healthy", "service": "ml-prediction-service"}
```

#### 3. POST /api/forward — Тестирование предсказания
1. Нажмите **Try it out**
2. В поле **Request body** вставьте тестовые данные:

```json
{
  "data": {
    "TransactionAmt": 189.0,
    "C1": 1.0,
    "C2": 2.0,
    "C4": 1.0,
    "C6": 0.5,
    "C11": 0.0,
    "C13": 1.0,
    "C14": 1.0,
    "D2": 10.0,
    "D3": 5.0,
    "D8": 2.0,
    "V34": 0.1,
    "V57": 0.2,
    "V91": 0.3,
    "V200": 0.4,
    "V281": 0.5,
    "V283": 0.6,
    "V294": 0.7,
    "addr1": 150,
    "card1": 15000,
    "card2": 226,
    "card3": 150,
    "card4": "visa",
    "card5": 226,
    "card6": "debit",
    "DeviceInfo": "Windows Chrome",
    "P_emaildomain": "gmail.com",
    "R_emaildomain": "gmail.com",
    "M4": "M0",
    "M5": "M0"
  }
}
```

3. Нажмите **Execute**

**Ожидаемый результат:**  
JSON с полями `prediction` и `probability`

#### 4. GET /api/history — Проверка истории
После выполнения POST-запроса:
1. Нажмите **Try it out**
2. Нажмите **Execute**

**Ожидаемый результат:**  
Список всех сохраненных запросов (включая только что выполненный)

#### 5. GET /api/history/stats — Статистика
1. Нажмите **Try it out**
2. Нажмите **Execute**

**Ожидаемый результат:**  
Статистика по всем запросам (количество, средние значения)

### Тестирование ошибок

#### 1. Тест с неполными данными
```json
{
  "data": {
    "TransactionAmt": 189.0
  }
}
```

**Ожидаемый результат:**  
Ошибка **400** с указанием отсутствующих переменных

#### 2. Тест с некорректным JSON
```json
{
  "data": "invalid data"
}
```

**Ожидаемый результат:**  
Ошибка валидации данных **422** с описанием проблемы
